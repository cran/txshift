<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Nima Hejazi and David Benkeser" />

<meta name="date" content="2021-02-06" />

<title>Targeted Learning with Stochastic Treatment Regimes</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Targeted Learning with Stochastic Treatment Regimes</h1>
<h4 class="author"><a href="https://nimahejazi.org">Nima Hejazi</a> and <a href="https://www.sph.emory.edu/faculty/profile/#!dbenkes">David Benkeser</a></h4>
<h4 class="date">2021-02-06</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Stochastic treatment regimes present a relatively simple manner in which to assess the effects of continuous treatments by way of parameters that examine the effects induced by the counterfactual shifting of the observed values of a treatment of interest. Here, we present an implementation of a new algorithm for computing targeted minimum loss-based estimates of treatment shift parameters defined based on a shifting function <span class="math inline">\(d(A,W)\)</span>. For a technical presentation of the algorithm, the interested reader is invited to consult <span class="citation">Dı́az and van der Laan (2018)</span>. For additional background on Targeted Learning and previous work on stochastic treatment regimes, please consider consulting <span class="citation">van der Laan and Rose (2011)</span>, <span class="citation">van der Laan and Rose (2018)</span>, and <span class="citation">Dı́az and van der Laan (2012)</span>.</p>
<p>To start, let’s load the packages we’ll use and set a seed for simulation:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(haldensify)</a></code></pre></div>
<pre><code>## haldensify v0.0.6: Highly Adaptive Lasso Conditional Density Estimation</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">library</span>(txshift)</a></code></pre></div>
<pre><code>## txshift v0.3.5: Efficient Estimation of the Causal Effects of Stochastic Interventions</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">set.seed</span>(<span class="dv">429153</span>)</a></code></pre></div>
<hr />
</div>
<div id="data-and-notation" class="section level2">
<h2>Data and Notation</h2>
<p>Consider <span class="math inline">\(n\)</span> observed units <span class="math inline">\(O_1, \ldots, O_n\)</span>, where each random variable <span class="math inline">\(O = (W, A, Y)\)</span> corresponds to a single observational unit. Let <span class="math inline">\(W\)</span> denote baseline covariates (e.g., age, sex, education level), <span class="math inline">\(A\)</span> an intervention variable of interest (e.g., nutritional supplements), and <span class="math inline">\(Y\)</span> an outcome of interest (e.g., disease status). Though it need not be the case, let <span class="math inline">\(A\)</span> be continuous-valued, i.e. <span class="math inline">\(A \in \mathbb{R}\)</span>. Let <span class="math inline">\(O_i \sim \mathcal{P} \in \mathcal{M}\)</span>, where <span class="math inline">\(\mathcal{M}\)</span> is the nonparametric statistical model defined as the set of continuous densities on <span class="math inline">\(O\)</span> with respect to some dominating measure. To formalize the definition of stochastic interventions and their corresponding causal effects, we introduce a nonparametric structural equation model (NPSEM), based on <span class="citation">Pearl (2000)</span>, to define how the system changes under posited interventions: <span class="math display">\[\begin{align*}\label{eqn:npsem}
  W &amp;= f_W(U_W) \\ A &amp;= f_A(W, U_A) \\ Y &amp;= f_Y(A, W, U_Y),
\end{align*}\]</span> We denote the observed data structure <span class="math inline">\(O = (W, A, Y)\)</span></p>
<p>Letting <span class="math inline">\(A\)</span> denote a continuous-valued treatment, we assume that the distribution of <span class="math inline">\(A\)</span> conditional on <span class="math inline">\(W = w\)</span> has support in the interval <span class="math inline">\((l(w), u(w))\)</span> – for convenience, let this support be <em>a.e.</em> That is, the minimum natural value of treatment <span class="math inline">\(A\)</span> for an individual with covariates <span class="math inline">\(W = w\)</span> is <span class="math inline">\(l(w)\)</span>; similarly, the maximum is <span class="math inline">\(u(w)\)</span>. Then, a simple stochastic intervention, based on a shift <span class="math inline">\(\delta\)</span>, may be defined <span class="math display">\[\begin{equation}\label{eqn:shift}
  d(a, w) =
  \begin{cases}
    a - \delta &amp; \text{if } a &gt; l(w) + \delta \\
    a &amp; \text{if } a \leq l(w) + \delta,
  \end{cases}
\end{equation}\]</span> where <span class="math inline">\(0 \leq \delta \leq u(w)\)</span> is an arbitrary pre-specified value that defines the degree to which the observed value <span class="math inline">\(A\)</span> is to be shifted, where possible. For the purpose of using such a shift in practice, the present software provides estimators for a shift function that assumes that the density of treatment <span class="math inline">\(A\)</span>, conditional on the covariates <span class="math inline">\(W\)</span>, has support <em>a.e.</em></p>
<div id="simulate-data" class="section level3">
<h3>Simulate Data</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># simulate simple data for tmle-shift sketch</span></a>
<a class="sourceLine" id="cb6-2" title="2">n_obs &lt;-<span class="st"> </span><span class="dv">1000</span>  <span class="co"># number of observations</span></a>
<a class="sourceLine" id="cb6-3" title="3">n_w &lt;-<span class="st"> </span><span class="dv">1</span>  <span class="co"># number of baseline covariates</span></a>
<a class="sourceLine" id="cb6-4" title="4">tx_mult &lt;-<span class="st"> </span><span class="dv">2</span>  <span class="co"># multiplier for the effect of W = 1 on the treatment</span></a>
<a class="sourceLine" id="cb6-5" title="5"></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">## baseline covariate -- simple, binary</span></a>
<a class="sourceLine" id="cb6-7" title="7">W &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">replicate</span>(n_w, <span class="kw">rbinom</span>(n_obs, <span class="dv">1</span>, <span class="fl">0.5</span>)))</a>
<a class="sourceLine" id="cb6-8" title="8"></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co">## create treatment based on baseline W</span></a>
<a class="sourceLine" id="cb6-10" title="10">A &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">rnorm</span>(n_obs, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co"># create outcome as a linear function of A, W + white noise</span></a>
<a class="sourceLine" id="cb6-13" title="13">Y &lt;-<span class="st"> </span>A <span class="op">+</span><span class="st"> </span>W <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-14" title="14"></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="co"># shift parameter</span></a>
<a class="sourceLine" id="cb6-16" title="16">delta &lt;-<span class="st"> </span><span class="fl">0.5</span></a></code></pre></div>
</div>
</div>
<div id="methodology" class="section level2">
<h2>Methodology</h2>
<div id="estimating-stochastic-interventions-effects-with-generalized-linear-models" class="section level3">
<h3>Estimating Stochastic Interventions Effects with Generalized Linear Models</h3>
<p>The simplest way to compute the TML estimator for the stochastic treatment regime is to fit each of the major constituent parts (nuisance parameters) of the estimator with generalized linear models. To do this, one may merely call the <code>txshift</code> function, providing the standard inputs listed below.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">tmle_hal_shift_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">txshift</span>(</a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb7-3" title="3">  <span class="dt">fluctuation =</span> <span class="st">&quot;standard&quot;</span>,</a>
<a class="sourceLine" id="cb7-4" title="4">  <span class="dt">g_exp_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;hal&quot;</span>, <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb7-5" title="5">                        <span class="dt">grid_type =</span> <span class="st">&quot;equal_mass&quot;</span>,</a>
<a class="sourceLine" id="cb7-6" title="6">                        <span class="dt">lambda_seq =</span> <span class="kw">exp</span>(<span class="kw">seq</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-12</span>, <span class="dt">length =</span> <span class="dv">500</span>))),</a>
<a class="sourceLine" id="cb7-7" title="7">  <span class="dt">Q_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;glm&quot;</span>, <span class="dt">glm_formula =</span> <span class="st">&quot;Y ~ .&quot;</span>)</a>
<a class="sourceLine" id="cb7-8" title="8">)</a>
<a class="sourceLine" id="cb7-9" title="9">tmle_hal_shift_<span class="dv">1</span></a></code></pre></div>
<pre><code>## Counterfactual Mean of Shifted Treatment</code></pre>
<pre><code>## Intervention: Treatment + 0.5</code></pre>
<pre><code>## txshift Estimator: tmle</code></pre>
<pre><code>## Estimate: 2.0528</code></pre>
<pre><code>## Std. Error: 0.0678</code></pre>
<pre><code>## 95% CI: [1.9199, 2.1858]</code></pre>
<p>When computing any such TML estimator, we may, of course, vary the regressions used in fitting the nuisance parameters; however, an even simpler variation is to fit the step for the fluctuation submodels with a <em>weighted</em> method, simply weighting each observation by an auxiliary covariate (often denoted <span class="math inline">\(H_n\)</span>, and sometimes called the “clever covariate” in the literature) rather than using such a covariate directly in the submodel regression fit.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">tmle_hal_shift_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">txshift</span>(</a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="dt">fluctuation =</span> <span class="st">&quot;weighted&quot;</span>,</a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="dt">g_exp_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;hal&quot;</span>, <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb14-5" title="5">                        <span class="dt">grid_type =</span> <span class="st">&quot;equal_mass&quot;</span>,</a>
<a class="sourceLine" id="cb14-6" title="6">                        <span class="dt">lambda_seq =</span> <span class="kw">exp</span>(<span class="kw">seq</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-12</span>, <span class="dt">length =</span> <span class="dv">500</span>))),</a>
<a class="sourceLine" id="cb14-7" title="7">  <span class="dt">Q_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;glm&quot;</span>, <span class="dt">glm_formula =</span> <span class="st">&quot;Y ~ .&quot;</span>)</a>
<a class="sourceLine" id="cb14-8" title="8">)</a>
<a class="sourceLine" id="cb14-9" title="9">tmle_hal_shift_<span class="dv">2</span></a></code></pre></div>
<pre><code>## Counterfactual Mean of Shifted Treatment</code></pre>
<pre><code>## Intervention: Treatment + 0.5</code></pre>
<pre><code>## txshift Estimator: tmle</code></pre>
<pre><code>## Estimate: 2.0524</code></pre>
<pre><code>## Std. Error: 0.0678</code></pre>
<pre><code>## 95% CI: [1.9195, 2.1854]</code></pre>
</div>
<div id="interlude-constructing-optimal-stacked-regressions-with-sl3" class="section level3">
<h3>Interlude: Constructing Optimal Stacked Regressions with <code>sl3</code></h3>
<p>To easily incorporate ensemble machine learning into the estimation procedure, we rely on the facilities provided in the <a href="https://tlverse.org/sl3/"><code>sl3</code> R package</a> <span class="citation">(Coyle et al. 2020)</span>. For a complete guide on using the <code>sl3</code> R package, consider consulting <a href="https://tlverse.org/sl3/" class="uri">https://tlverse.org/sl3/</a> and <a href="https://tlverse.org/tlverse-handbook/sl3.html" class="uri">https://tlverse.org/tlverse-handbook/sl3.html</a>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="co"># SL learners to be used for most fits (e.g., IPCW, outcome regression)</span></a>
<a class="sourceLine" id="cb21-2" title="2">mean_learner &lt;-<span class="st"> </span>Lrnr_mean<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb21-3" title="3">glm_learner &lt;-<span class="st"> </span>Lrnr_glm<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb21-4" title="4">rf_learner &lt;-<span class="st"> </span>Lrnr_ranger<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb21-5" title="5">Q_lib &lt;-<span class="st"> </span>Stack<span class="op">$</span><span class="kw">new</span>(mean_learner, glm_learner, rf_learner)</a>
<a class="sourceLine" id="cb21-6" title="6">sl_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> Q_lib, <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>())</a>
<a class="sourceLine" id="cb21-7" title="7"></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="co"># SL learners for fitting the generalized propensity score fit</span></a>
<a class="sourceLine" id="cb21-9" title="9">hse_learner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_density_semiparametric,</a>
<a class="sourceLine" id="cb21-10" title="10">  <span class="dt">mean_learner =</span> glm_learner</a>
<a class="sourceLine" id="cb21-11" title="11">)</a>
<a class="sourceLine" id="cb21-12" title="12">mvd_learner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_density_semiparametric,</a>
<a class="sourceLine" id="cb21-13" title="13">  <span class="dt">mean_learner =</span> rf_learner,</a>
<a class="sourceLine" id="cb21-14" title="14">  <span class="dt">var_learner =</span> glm_learner</a>
<a class="sourceLine" id="cb21-15" title="15">)</a>
<a class="sourceLine" id="cb21-16" title="16">g_lib &lt;-<span class="st"> </span>Stack<span class="op">$</span><span class="kw">new</span>(hse_learner, mvd_learner)</a>
<a class="sourceLine" id="cb21-17" title="17">sl_learner_density &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> g_lib,</a>
<a class="sourceLine" id="cb21-18" title="18">                                  <span class="dt">metalearner =</span> Lrnr_solnp_density<span class="op">$</span><span class="kw">new</span>())</a></code></pre></div>
</div>
<div id="estimating-stochastic-interventions-effects-with-stacked-regressions" class="section level3">
<h3>Estimating Stochastic Interventions Effects with Stacked Regressions</h3>
<p>Using the framework provided by the <a href="https://tlverse.org/sl3/"><code>sl3</code> package</a>, the nuisance parameters of the TML estimator may be fit with ensemble learning, using the cross-validation framework of the Super Learner algorithm of <span class="citation">van der Laan, Polley, and Hubbard (2007)</span>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">tmle_sl_shift_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">txshift</span>(</a>
<a class="sourceLine" id="cb22-2" title="2">  <span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb22-3" title="3">  <span class="dt">fluctuation =</span> <span class="st">&quot;standard&quot;</span>,</a>
<a class="sourceLine" id="cb22-4" title="4">  <span class="dt">g_exp_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;sl&quot;</span>,</a>
<a class="sourceLine" id="cb22-5" title="5">                        <span class="dt">sl_learners_density =</span> sl_learner_density),</a>
<a class="sourceLine" id="cb22-6" title="6">  <span class="dt">Q_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;sl&quot;</span>, <span class="dt">sl_learners =</span> sl_learner)</a>
<a class="sourceLine" id="cb22-7" title="7">)</a>
<a class="sourceLine" id="cb22-8" title="8">tmle_sl_shift_<span class="dv">1</span></a></code></pre></div>
<p>As before, we may vary the regression for the submodel fluctuation procedure by weighting each observation by the value of the so-called clever covariate rather than using such an auxiliary covariate directly in the regression procedure:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">tmle_sl_shift_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">txshift</span>(</a>
<a class="sourceLine" id="cb23-2" title="2">  <span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb23-3" title="3">  <span class="dt">fluctuation =</span> <span class="st">&quot;weighted&quot;</span>,</a>
<a class="sourceLine" id="cb23-4" title="4">  <span class="dt">g_exp_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;sl&quot;</span>,</a>
<a class="sourceLine" id="cb23-5" title="5">                        <span class="dt">sl_learners_density =</span> sl_learner_density),</a>
<a class="sourceLine" id="cb23-6" title="6">  <span class="dt">Q_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;sl&quot;</span>, <span class="dt">sl_learners =</span> sl_learner)</a>
<a class="sourceLine" id="cb23-7" title="7">)</a>
<a class="sourceLine" id="cb23-8" title="8">tmle_sl_shift_<span class="dv">2</span></a></code></pre></div>
</div>
<div id="statistical-inference-for-targeted-maximum-likelihood-estimates" class="section level3">
<h3>Statistical Inference for Targeted Maximum Likelihood Estimates</h3>
<p>Recall that the asymptotic distribution of TML estimators has been studied thoroughly: <span class="math display">\[\psi_n - \psi_0 = (P_n - P_0) \cdot D(\bar{Q}_n^*, g_n) + R(\hat{P}^*, P_0),\]</span> which, provided the following two conditions:</p>
<ol style="list-style-type: decimal">
<li>If <span class="math inline">\(D(\bar{Q}_n^{\star}, g_n)\)</span> converges to <span class="math inline">\(D(P_0)\)</span> in <span class="math inline">\(L_2(P_0)\)</span> norm, and</li>
<li>the size of the class of functions considered for estimation of <span class="math inline">\(\bar{Q}_n^{\star}\)</span> and <span class="math inline">\(g_n\)</span> is bounded (technically, <span class="math inline">\(\exists \mathcal{F}\)</span> st <span class="math inline">\(D(\bar{Q}_n^{\star}, g_n) \in \mathcal{F}\)</span> <em><strong>whp</strong></em>, where <span class="math inline">\(\mathcal{F}\)</span> is a Donsker class), readily admits the conclusion that <span class="math inline">\(\psi_n - \psi_0 = (P_n - P_0) \cdot D(P_0) + R(\hat{P}^{\star}, P_0)\)</span>.</li>
</ol>
<p>Under the additional condition that the remainder term <span class="math inline">\(R(\hat{P}^{\star}, P_0)\)</span> decays as <span class="math inline">\(o_P \left( \frac{1}{\sqrt{n}} \right),\)</span> we have that <span class="math display">\[\psi_n - \psi_0 = (P_n - P_0) \cdot D(P_0) + o_P \left( \frac{1}{\sqrt{n}}
 \right),\]</span> which, by a central limit theorem, establishes a Gaussian limiting distribution for the estimator:</p>
<p><span class="math display">\[\sqrt{n}(\psi_n - \psi) \to N(0, V(D(P_0))),\]</span> where <span class="math inline">\(V(D(P_0))\)</span> is the variance of the efficient influence curve (canonical gradient) when <span class="math inline">\(\psi\)</span> admits an asymptotically linear representation.</p>
<p>The above implies that <span class="math inline">\(\psi_n\)</span> is a <span class="math inline">\(\sqrt{n}\)</span>-consistent estimator of <span class="math inline">\(\psi\)</span>, that it is asymptotically normal (as given above), and that it is locally efficient. This allows us to build Wald-type confidence intervals in a straightforward manner:</p>
<p><span class="math display">\[\psi_n \pm z_{\alpha} \cdot \frac{\sigma_n}{\sqrt{n}},\]</span> where <span class="math inline">\(\sigma_n^2\)</span> is an estimator of <span class="math inline">\(V(D(P_0))\)</span>. The estimator <span class="math inline">\(\sigma_n^2\)</span> may be obtained using the bootstrap or computed directly via the following</p>
<p><span class="math display">\[\sigma_n^2 = \frac{1}{n} \sum_{i = 1}^{n} D^2(\bar{Q}_n^{\star}, g_n)(O_i)\]</span></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">(ci_param &lt;-<span class="st"> </span><span class="kw">confint</span>(tmle_hal_shift_<span class="dv">1</span>))</a></code></pre></div>
<pre><code>##   lwr_ci      est   upr_ci 
## 1.919883 2.052831 2.185778</code></pre>
</div>
</div>
<div id="advanced-usage-user-specified-regressions" class="section level2">
<h2><em>Advanced Usage:</em> User-Specified Regressions</h2>
<p>In some special cases it may be useful for the experienced user to compute the treatment mechanism and outcome regressions separately (i.e., outside of the <code>tmle_txshift</code> wrapper function), instead applying this user-facing wrapper only to invoke the <em>targeting</em> steps involved in computing the TML estimator for the treatment shift parameter. In such cases, the optional arguments <code>gn_fit_ext</code> and <code>Qn_fit_ext</code> may be utilized. We present a case of using these here:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"><span class="co"># compute treatment mechanism (propensity score) externally</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="co">## first, produce the down-shifted treatment data</span></a>
<a class="sourceLine" id="cb26-3" title="3">gn_downshift &lt;-<span class="st"> </span><span class="kw">dnorm</span>(A <span class="op">-</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb26-4" title="4"><span class="co">## next, initialize and produce the up-shifted treatment data</span></a>
<a class="sourceLine" id="cb26-5" title="5">gn_upshift &lt;-<span class="st"> </span><span class="kw">dnorm</span>(A <span class="op">+</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb26-6" title="6"><span class="co">## now, initialize and produce the up-up-shifted (2 * delta) treatment data</span></a>
<a class="sourceLine" id="cb26-7" title="7">gn_upupshift &lt;-<span class="st"> </span><span class="kw">dnorm</span>(A <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb26-8" title="8"><span class="co">## then, initialize and produce the un-shifted treatment data</span></a>
<a class="sourceLine" id="cb26-9" title="9">gn_noshift &lt;-<span class="st"> </span><span class="kw">dnorm</span>(A, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb26-10" title="10"><span class="co">## finally, put it all together into an object like what&#39;s produced internally</span></a>
<a class="sourceLine" id="cb26-11" title="11">gn_out &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">cbind</span>(gn_downshift, gn_noshift, gn_upshift,</a>
<a class="sourceLine" id="cb26-12" title="12">                              gn_upupshift))</a>
<a class="sourceLine" id="cb26-13" title="13"><span class="kw">setnames</span>(gn_out, <span class="kw">c</span>(<span class="st">&quot;downshift&quot;</span>, <span class="st">&quot;noshift&quot;</span>, <span class="st">&quot;upshift&quot;</span>, <span class="st">&quot;upupshift&quot;</span>))</a>
<a class="sourceLine" id="cb26-14" title="14"></a>
<a class="sourceLine" id="cb26-15" title="15"><span class="co"># compute outcome regression externally</span></a>
<a class="sourceLine" id="cb26-16" title="16">Qn_noshift &lt;-<span class="st"> </span>(W <span class="op">+</span><span class="st"> </span>A <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(Y)) <span class="op">/</span><span class="st"> </span><span class="kw">diff</span>(<span class="kw">range</span>(Y))</a>
<a class="sourceLine" id="cb26-17" title="17">Qn_upshift &lt;-<span class="st"> </span>(W <span class="op">+</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>delta <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(Y)) <span class="op">/</span><span class="st"> </span><span class="kw">diff</span>(<span class="kw">range</span>(Y))</a>
<a class="sourceLine" id="cb26-18" title="18">Qn_noshift[Qn_noshift <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb26-19" title="19">Qn_noshift[Qn_noshift <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb26-20" title="20">Qn_upshift[Qn_upshift <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb26-21" title="21">Qn_upshift[Qn_upshift <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb26-22" title="22">Qn_out &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">cbind</span>(Qn_noshift, Qn_upshift))</a>
<a class="sourceLine" id="cb26-23" title="23"><span class="kw">setnames</span>(Qn_out, <span class="kw">c</span>(<span class="st">&quot;noshift&quot;</span>, <span class="st">&quot;upshift&quot;</span>))</a>
<a class="sourceLine" id="cb26-24" title="24"></a>
<a class="sourceLine" id="cb26-25" title="25"><span class="co"># invoke the wrapper function only to apply the targeting step</span></a>
<a class="sourceLine" id="cb26-26" title="26">tmle_shift_spec &lt;-<span class="st"> </span><span class="kw">txshift</span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb26-27" title="27">                           <span class="dt">fluctuation =</span> <span class="st">&quot;standard&quot;</span>,</a>
<a class="sourceLine" id="cb26-28" title="28">                           <span class="dt">samp_fit_args =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb26-29" title="29">                           <span class="dt">g_exp_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;external&quot;</span>),</a>
<a class="sourceLine" id="cb26-30" title="30">                           <span class="dt">Q_fit_args =</span> <span class="kw">list</span>(<span class="dt">fit_type =</span> <span class="st">&quot;external&quot;</span>),</a>
<a class="sourceLine" id="cb26-31" title="31">                           <span class="dt">gn_exp_fit_ext =</span> gn_out,</a>
<a class="sourceLine" id="cb26-32" title="32">                           <span class="dt">Qn_fit_ext =</span> Qn_out)</a>
<a class="sourceLine" id="cb26-33" title="33">tmle_shift_spec</a></code></pre></div>
<pre><code>## Counterfactual Mean of Shifted Treatment</code></pre>
<pre><code>## Intervention: Treatment + 0.5</code></pre>
<pre><code>## txshift Estimator: tmle</code></pre>
<pre><code>## Estimate: 2.0689</code></pre>
<pre><code>## Std. Error: 0.0693</code></pre>
<pre><code>## 95% CI: [1.933, 2.2047]</code></pre>
<hr />
</div>
<div id="references" class="section level2 unnumbered">
<h2>References</h2>
<div id="refs" class="references">
<div id="ref-coyle2020sl3">
<p>Coyle, Jeremy R, Nima S Hejazi, Ivana Malenica, and Oleg Sofrygin. 2020. <em>sl3: Modern Pipelines for Machine Learning and Super Learning</em>. <a href="https://github.com/tlverse/sl3">https://github.com/tlverse/sl3</a>. <a href="https://doi.org/10.5281/zenodo.1342293">https://doi.org/10.5281/zenodo.1342293</a>.</p>
</div>
<div id="ref-diaz2012population">
<p>Dı́az, Iván, and Mark J van der Laan. 2012. “Population Intervention Causal Effects Based on Stochastic Interventions.” <em>Biometrics</em> 68 (2): 541–49.</p>
</div>
<div id="ref-diaz2018stochastic">
<p>———. 2018. “Stochastic Treatment Regimes.” In <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>, 167–80. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-pearl2000causality">
<p>Pearl, Judea. 2000. <em>Causality</em>. Cambridge university press.</p>
</div>
<div id="ref-vdl2007super">
<p>van der Laan, Mark J, Eric C Polley, and Alan E Hubbard. 2007. “Super Learner.” <em>Statistical Applications in Genetics and Molecular Biology</em> 6 (1).</p>
</div>
<div id="ref-vdl2011targeted">
<p>van der Laan, Mark J, and Sherri Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-vdl2018targeted">
<p>———. 2018. <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>. Springer Science &amp; Business Media.</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
